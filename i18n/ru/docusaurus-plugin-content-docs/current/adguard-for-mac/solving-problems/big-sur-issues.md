---
title: Проблемы совместимости с различными версиями macOS
sidebar_position: 4
---

## Известные проблемы

Каждый год Apple выпускает новую версию macOS, внедряя инновационные решения и добавляя полезные функции. Но некоторые из них, такие как Network Extensions API (Big Sur) или iCloud Private Relay (Monterey), вызывают проблемы у многих приложений, и AdGuard не исключение. В этой статье мы рассмотрим известные проблемы, характерные для каждой версии macOS, и возможные способы их решения.

### Монтерей 12: известные проблемы

Эти проблемы ещё не устранены компанией Apple или устранены лишь частично.

#### Совместимость с iCloud Private Relay

В настоящее время AdGuard и iCloud Private Relay не могут работать одновременно. AdGuard не может блокировать рекламу, так как iCloud Private Relay шифрует трафик до того, как AdGuard сможет фильтровать сетевые соединения. Использование iCloud Private Relay блокирует любую фильтрацию, включая локальную. Таким образом, AdGuard не может фильтровать трафик или выполнять DNS-фильтрацию в Safari. Поэтому по умолчанию AdGuard использует "default route", который отключает iCloud Private Relay.

For a deeper understanding of this problem, read [this article](../icloud-private-relay).

**Рекомендуемое решение**

Мы рекомендуем использовать AdGuard вместе с более традиционным VPN-сервисом, таким как [AdGuard VPN](https://adguard-vpn.com/).

**Альтернативное решение**

Вы можете запретить AdGuard использовать "default route", отключив последний. It can be done via Advanced Settings → `network.extension.monterey.force.split.tunnel`. Имейте в виду, что в этом случае вы столкнётесь с проблемами, описанными выше.

![Advanced Settings *border](https://cdn.adtidy.org/content/kb/ad_blocker/mac/mac_adguard_advanced_settings.jpg)

#### Совместимость с Защитой конфиденциальности в Почте

Приложение Почта Apple теперь использует прокси-сервер для скрытия IP-адреса пользователя при загрузке изображений из электронных писем. Но эта функция не работает при наличии активного VPN-соединения. Поскольку AdGuard рассматривается Почтой Apple как VPN, изображения не загружаются автоматически.

For a deeper understanding of this problem, read [this article](../protect-mail-activity).

**Рекомендуемое решение**

Мы рекомендуем использовать более традиционный VPN-сервис, такой как AdGuard VPN, вместо новых функций конфиденциальности Apple.

### Monterey 12, Big Sur 11.6 и более поздние версии: существующие проблемы

Эти проблемы ещё не устранены компанией Apple или устранены лишь частично.

#### Совместимость с Cisco AnyConnect

AdGuard не будет работать вместе с Cisco AnyConnect, если находится в режиме фильтрации *Network Extension*. Вам нужно переключить AdGuard в режим *Автоматический прокси*. To do so, follow [this instruction](#automatic-proxy).


#### Совместимость с Flutter

> Эта проблема решена в релизе Flutter 2.2, выпущенном в июне 2021 года. Но для приложений, разработанных на Flutter, проблема остаётся актуальной до выпуска обновлений. Если вы используете Flutter параллельно с AdGuard в режиме Network Extension (или с любым другим приложением типа Transparent Proxy) на Monterey или Big Sur, вы столкнётесь с проблемами: проекты не будут открываться и приложение окажется, по сути, сломанным. Мы уже сообщили Apple об этом баге. Тем временем, вы можете использовать одно из этих временных решений:

1) Используйте AdGuard в режиме [Автоматический прокси](#automatic-proxy).

2) Disable SIP and switch AdGuard to Kernel Extension mode as explained [here](#kernel-extension).

#### VPN-приложения со старым API

Несмотря на то, что AdGuard отображается в системных настройках как VPN, конфликтов с другими приложениями на основе VPN возникнуть не должно. Но если вы используете VPN-приложение, скачанное не из App Store, есть шанс, что оно использует старое VPN API. В таком случае необходимо исключить его из фильтрации:

1) Откройте меню AdGuard. 2) Выберите *Настройки....*. 3) Переключитесь на вкладку *Сеть*. 4) Кликните по кнопке *Приложения...*. 5) Найдите приложение, которое вы хотите добавить в исключения, и уберите галочку напротив него.

![Фильтруемые приложения](https://cdn.adtidy.org/content/kb/ad_blocker/mac/legacy.jpg)

## Исправленные проблемы

Эти проблемы уже решены разработчиками Apple, но могут встречаться на более старых версиях macOS Big Sur.

### Совместимость с Little Snitch 5

На момент написания статьи режим фильтрации Network Extension в AdGuard не совместим с [Little Snitch 5](https://obdev.at/products/littlesnitch/index.html). Когда они оба запущены, существует вероятность столкнуться с проблемами в поведении различных приложений, даже если они исключены из фильтрации в AdGuard. Эта проблема вызвана багом в Big Sur, о котором мы уже проинформировали Apple. Это позволяет надеяться, что в ближайших обновлениях он будет исправлен.

Проблему нельзя решить отключением мониторинга соединений в Little Snitch, поскольку это не выгружает его расширение из системы. We recommend to switch to [**Automatic Proxy**](#automatic-proxy) filtering mode when running AdGuard alongside with Little Snitch on Big Sur, at least until Apple fixes the bug.

### Совместимость с локальными прокси

> Теперь AdGuard может фильтровать локальные прокси без проблем (в большинстве случаев). Если вы всё же столкнулись с какими-либо трудностями на OS 11.1 и выше или если вы используете Big Sur 11.0, уберите локальный прокси из системных настроек и настройте вышестоящий прокси в AdGuard, следуя инструкции ниже.

To configure an upstream proxy in AdGuard for Mac in Big Sur, you need to go to *AdGuard menu → Advanced → Advanced Settings...*. Кликните по области *Значение* настройки `upstream.proxy`, чтобы настроить прокси.

![Настройки прокси в AdGuard for Mac на Big Sur](https://cdn.adtidy.org/content/kb/ad_blocker/mac/proxy_en.jpg)

Введите строку вида `scheme://user:password@host:port`, где

* `scheme` имеет значение `http`, `https`, `socks4` или `socks5`, в зависимости от типа прокси,

> Если вы используете тип прокси `socks5`, установите значение настройки `upstream.proxy.socks5udp` как `true`, чтобы AdGuard направлял UDP-трафик через прокси-сервер.

* `user` и `password` — имя пользователя и пароль от вашего прокси соответственно (если требуются). Игнорируйте эти параметры, если один или оба не применимы к данному прокси,
* `host` — IP-адрес вашего прокси-сервера,
* `port` — желаемый номер порта, который будет использоваться прокси-сервером.

> Пример: строка `socks5://localhost:6322` настроит локальный прокси типа SOCKS5, который слушает порт 6322 и не требует имени пользователя и пароля.

Нажмите *Применить*, чтобы заставить AdGuard пересылать весь трафик через настроенный прокси-сервер.

Если у вас возникли трудности, напишите в поддержку: support@adguard.com.

#### Пример 1: Настройка вышестоящего прокси Shadowsocks

Here's an example of how to configure an upstream proxy for [Shadowsocks](https://shadowsocks.org).

Прежде всего, вам потребуется настроить работу серверной части прокси. Вероятнее всего, для этого вы будете использовать JSON-файл наподобие этого (значения полей `server` и `password` здесь выбраны случайным образом):

```
{
   "server":"111.222.333.444",
   "server_port":8388,
   "local_port":1080,
   "password":"barfoo!",
   "timeout":600,
   "method":"chacha20-ietf-poly1305"
}
```

> You can find more information about how to get started on [Shadowsocks website](https://shadowsocks.org/guide/what-is-shadowsocks.html).

Затем надо установить клиент Shadowsocks на Mac. Убедитесь, что вы выбрали Ручной или Автоматический режим в настройках. Конфигурация с Global Mode работать не будет. В версиях Big Sur ниже 11.1 также не будет работать Автоматический режим.

![Select Manual Mode or Auto Mode in settings *mobile](https://cdn.adtidy.org/content/kb/ad_blocker/mac/shadowsocks.jpg)

Now go to *AdGuard menu → Advanced → Advanced Settings...* and set the *Value* area of the `upstream.proxy` setting to `socks5://localhost:1080`. Обратите внимание, что здесь необходимо использовать значение "local_port" из JSON-файла, упомянутого выше.

Поскольку Shadowsocks использует SOCKS5, вам также понадобится изменить значение настройки `upstream.proxy.socks5udp` в Расширенных настройках AdGuard на `true`, чтобы AdGuard направлял UDP-трафик вашего Mac через прокси-сервер.

#### Пример 2: Настройка вышестоящего прокси Surge

В версиях Big Sur 11.1 и выше не существует известных конфликтов между AdGuard и Surge. Если вы используете более старую версию Big Sur, убедитесь, что в правом нижнем углу отключён **системный прокси**. В противном случае Surge не будет работать вместе с AdGuard. С другой стороны, **Enhanced Mode** включать можно на любой версии системы, он не вызовет конфликтов.

![Configuring an upstream Surge proxy *border](https://cdn.adtidy.org/content/kb/ad_blocker/mac/surge.jpg)

Now go to *AdGuard menu → Advanced → Advanced Settings...* and set the *Value* area of the `upstream.proxy` setting to `socks5://localhost:6153` or `http://localhost:6152`, depending on which type of proxy you want to use. Обратите внимание, что нужно использовать значение **port**, указанное в разделе **Events** вкладки **Activity** в вашем клиенте Surge.

Если вы выбрали протокол SOCKS5, измените значение настройки `upstream.proxy.socks5udp` в Расширенных настройках AdGuard на `true`, чтобы AdGuard мог пропускать UDP-трафик через прокси-сервер.

## Альтернативы использованию Network Extension

Невозможно предвидеть все потенциальные проблемы, которые могут возникнуть в Big Sur и Monterey, ведь существует бесчисленное количество комбинаций железа, софта и настроек. Так что если вы всё же столкнётесь с какими-либо сложностями, пожалуйста, напишите нам в поддержку — но также вы можете попробовать одно из альтернативных решений.

### Использовать режим фильтрации «Автоматический прокси» {#automatic-proxy}

Если вы столкнулись с проблемами в Big Sur или Monterey, которые нельзя решить способами, описанными выше, попробуйте переключить AdGuard в режим *Автоматический прокси*.

1) Откройте меню AdGuard. 2) Выберите *Настройки....*. 3) Переключитесь на вкладку *Сеть*. 4) Кликните по кнопке *Выбрать режим...*. 5) Выберите *Автоматический прокси*.

![Переключите AdGuard в режим «Автоматический прокси»](https://cdn.adtidy.org/content/kb/ad_blocker/mac/automatic-proxy_en.jpg)

AdGuard автоматически добавил **.pac-файл** в сетевые настройки вашего Mac, и теперь система будет распознавать AdGuard как прокси и попытается направлять через него весь трафик.

> Имейте в виду, что некоторые приложения могут игнорировать эту настройку и тогда их трафик не будет фильтроваться.

### Переключение на Kernel Extension в Big Sur и Monterey {#kernel-extension}

По умолчанию на Big Sur и Monterey AdGuard использует фреймворк Network Extension, так как старый фреймворк Kernel Extension там отключён. Это может вызывать проблемы совместимости, но чтобы включить Kernel Extension обратно, вам сначала потребуется отключить системную настройку безопасности (System Integrity Protection, или SIP). Чтобы отключить SIP, следуйте этой инструкции:

1) Кликните по *символу Apple* в строке меню. 2) Кликните *Перезагрузить…* 3) Зажмите *Command-R*, чтобы запустить систему в режиме восстановления. 4) Кликните по кнопке *Утилиты*. 5) Выберите *Терминал*. 6) Вбейте в появившемся окне `csrutil disable`. 7) Нажмите на клавиатуре клавишу *Return* или *Enter*. 8) Кликните по *символу Apple* в строке меню. 9) Кликните *Перезагрузить…*

Теперь, когда SIP отключён, выполните следующие шаги для включения Kernel Extension:

![Включить расширение Kernel](https://cdn.adtidy.org/content/kb/ad_blocker/mac/kernel_en.jpg)

1) Откройте меню AdGuard. 2) Выберите *Настройки....*. 3) Переключитесь на вкладку *Сеть*. 4) Кликните по кнопке *Выбрать режим...*. 5) Выберите *Расширение Kernel*. 6) Подтвердите, что хотите переключиться на него.

> Мы рекомендуем использовать этот метод только в том случае, если все остальные не дали результата, поскольку он может привести к непредвиденным последствиям.
